name: Toolify Data Collection

on:
  schedule:
    # æ¯æœˆ2å·å‡Œæ™¨2ç‚¹æ‰§è¡Œ (UTCæ—¶é—´)
    - cron: '0 2 2 * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      target_count:
        description: 'é‡‡é›†ç›®æ ‡æ•°é‡'
        required: false
        default: '3000'
        type: string
      quick_test:
        description: 'å¿«é€Ÿæµ‹è¯•æ¨¡å¼ (ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®)'
        required: false
        default: false
        type: boolean

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # å¢åŠ åˆ°90åˆ†é’Ÿï¼Œæ”¯æŒå¤§é‡æ•°æ®ä¸Šä¼ 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          echo "ğŸ“¦ å¼€å§‹å®‰è£…Pythonä¾èµ–åŒ…..."
          echo "ğŸ”„ å‡çº§pip..."
          python -m pip install --upgrade pip --timeout 60

          echo "ğŸ“‹ å®‰è£…ä¾èµ–åŒ…ï¼ˆå¸¦è¶…æ—¶å’Œè¿›åº¦æ˜¾ç¤ºï¼‰..."
          pip install --timeout 300 --verbose -r requirements.txt

          echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"
          echo "ğŸ“Š å·²å®‰è£…çš„åŒ…åˆ—è¡¨:"
          pip list | grep -E "(selenium|requests|webdriver-manager|python-dotenv)"

      - name: Install Chrome and ChromeDriver
        timeout-minutes: 10
        run: |
          echo "ğŸŒ å¼€å§‹å®‰è£…Chromeæµè§ˆå™¨..."
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable unzip wget

          echo "âœ… Chromeå®‰è£…å®Œæˆ"
          google-chrome --version

          # è·å–Chromeç‰ˆæœ¬
          CHROME_VERSION=$(google-chrome --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
          echo "Chrome version: $CHROME_VERSION"
          echo "Chrome major version: $MAJOR_VERSION"

          # å°è¯•å®‰è£…ChromeDriverï¼ˆå¤šç§æ–¹æ³•ï¼‰
          # æ–¹æ³•1: ä½¿ç”¨aptå®‰è£…ï¼ˆæœ€ç®€å•ï¼‰
          if sudo apt-get install -y chromium-chromedriver; then
            echo "âœ… ä½¿ç”¨aptå®‰è£…ChromeDriveræˆåŠŸ"
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver 2>/dev/null || true
          else
            echo "âš ï¸ aptå®‰è£…å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä¸‹è½½..."

            # æ–¹æ³•2: æ‰‹åŠ¨ä¸‹è½½ç¨³å®šç‰ˆæœ¬
            CHROMEDRIVER_VERSION="120.0.6099.109"
            echo "Using ChromeDriver version: $CHROMEDRIVER_VERSION"

            DOWNLOAD_URL="https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
            echo "Download URL: $DOWNLOAD_URL"

            if wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"; then
              sudo unzip /tmp/chromedriver.zip -d /tmp/
              sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
              sudo chmod +x /usr/local/bin/chromedriver
            else
              echo "âŒ ChromeDriverä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨webdriver-manager"
            fi
          fi

          # éªŒè¯ChromeDriveræ˜¯å¦å¯ç”¨
          if [ -f "/usr/local/bin/chromedriver" ]; then
            echo "âœ… ChromeDriverå®‰è£…æˆåŠŸ:"
            ls -la /usr/local/bin/chromedriver
            /usr/local/bin/chromedriver --version
          elif [ -f "/usr/bin/chromedriver" ]; then
            echo "âœ… ä½¿ç”¨ç³»ç»ŸChromeDriver:"
            ls -la /usr/bin/chromedriver
            /usr/bin/chromedriver --version
          else
            echo "âš ï¸ ChromeDriverå®‰è£…å¯èƒ½æœ‰é—®é¢˜ï¼Œå°†ä¾èµ–webdriver-manager"
          fi

      - name: Verify script files exist
        run: |
          echo "ğŸ” æ£€æŸ¥è„šæœ¬æ–‡ä»¶..."
          ls -la scripts/
          echo "ğŸ“‹ production-collector.py å†…å®¹å‰10è¡Œ:"
          head -10 scripts/production-collector.py
          echo "ğŸ”§ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
          chmod +x scripts/production-collector.py scripts/quick-test-collector.py

      - name: Run data collection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          INPUT_TARGET_COUNT: ${{ github.event.inputs.target_count }}
        run: |
          echo "ğŸ”§ ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          echo "   TARGET_COUNTè¾“å…¥: ${{ github.event.inputs.target_count }}"
          echo "   INPUT_TARGET_COUNT: $INPUT_TARGET_COUNT"
          echo "   QUICK_TESTæ¨¡å¼: ${{ github.event.inputs.quick_test }}"

          if [ "${{ github.event.inputs.quick_test }}" = "true" ]; then
            echo "ğŸ§ª è¿è¡Œå¿«é€Ÿæµ‹è¯•æ¨¡å¼..."
            echo "ğŸ“‹ æµ‹è¯•è„šæœ¬å‰5è¡Œ:"
            head -5 scripts/quick-test-collector.py
            python -u scripts/quick-test-collector.py
          else
            echo "ğŸ”„ è¿è¡Œå®Œæ•´æ•°æ®é‡‡é›†..."
            echo "ğŸ“‹ è„šæœ¬å‰5è¡Œ:"
            head -5 scripts/production-collector.py
            echo "ğŸš€ å¼€å§‹æ‰§è¡Œè„šæœ¬..."
            python -u scripts/production-collector.py
          fi

      - name: Upload backup on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: collection-backup-${{ github.run_number }}
          path: ./toolify-backup-*.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… æ•°æ®é‡‡é›†æˆåŠŸå®Œæˆäº $(date)"
          echo "ğŸ“Š æŸ¥çœ‹æœ€æ–°æ•°æ®: https://your-toolify-app.vercel.app"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ æ•°æ®é‡‡é›†å¤±è´¥äº $(date)"
          echo "ğŸ“‹ è¯·æ£€æŸ¥æ—¥å¿—å’Œå¤‡ä»½æ–‡ä»¶"