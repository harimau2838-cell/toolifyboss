name: Toolify Data Collection

on:
  schedule:
    # æ¯æœˆ2å·å‡Œæ™¨2ç‚¹æ‰§è¡Œ (UTCæ—¶é—´)
    - cron: '0 2 2 * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      target_count:
        description: 'é‡‡é›†ç›®æ ‡æ•°é‡'
        required: false
        default: '3000'
        type: string
      quick_test:
        description: 'å¿«é€Ÿæµ‹è¯•æ¨¡å¼ (ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®)'
        required: false
        default: false
        type: boolean

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          echo "ğŸ“¦ å¼€å§‹å®‰è£…Pythonä¾èµ–åŒ…..."
          echo "ğŸ”„ å‡çº§pip..."
          python -m pip install --upgrade pip --timeout 60

          echo "ğŸ“‹ å®‰è£…ä¾èµ–åŒ…ï¼ˆå¸¦è¶…æ—¶å’Œè¿›åº¦æ˜¾ç¤ºï¼‰..."
          pip install --timeout 300 --verbose -r requirements.txt

          echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"
          echo "ğŸ“Š å·²å®‰è£…çš„åŒ…åˆ—è¡¨:"
          pip list | grep -E "(selenium|requests|webdriver-manager|python-dotenv)"

      - name: Install Chrome and ChromeDriver
        timeout-minutes: 10
        run: |
          echo "ğŸŒ å¼€å§‹å®‰è£…Chromeæµè§ˆå™¨..."
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable unzip wget

          echo "âœ… Chromeå®‰è£…å®Œæˆ"
          google-chrome --version

          # è·å–Chromeç‰ˆæœ¬
          CHROME_VERSION=$(google-chrome --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
          echo "Chrome version: $CHROME_VERSION"
          echo "Chrome major version: $MAJOR_VERSION"

          # å°è¯•å®‰è£…ChromeDriverï¼ˆå¤šç§æ–¹æ³•ï¼‰
          # æ–¹æ³•1: ä½¿ç”¨aptå®‰è£…ï¼ˆæœ€ç®€å•ï¼‰
          if sudo apt-get install -y chromium-chromedriver; then
            echo "âœ… ä½¿ç”¨aptå®‰è£…ChromeDriveræˆåŠŸ"
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver 2>/dev/null || true
          else
            echo "âš ï¸ aptå®‰è£…å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä¸‹è½½..."

            # æ–¹æ³•2: æ‰‹åŠ¨ä¸‹è½½ç¨³å®šç‰ˆæœ¬
            CHROMEDRIVER_VERSION="120.0.6099.109"
            echo "Using ChromeDriver version: $CHROMEDRIVER_VERSION"

            DOWNLOAD_URL="https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
            echo "Download URL: $DOWNLOAD_URL"

            if wget -O /tmp/chromedriver.zip "$DOWNLOAD_URL"; then
              sudo unzip /tmp/chromedriver.zip -d /tmp/
              sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
              sudo chmod +x /usr/local/bin/chromedriver
            else
              echo "âŒ ChromeDriverä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨webdriver-manager"
            fi
          fi

          # éªŒè¯ChromeDriveræ˜¯å¦å¯ç”¨
          if [ -f "/usr/local/bin/chromedriver" ]; then
            echo "âœ… ChromeDriverå®‰è£…æˆåŠŸ:"
            ls -la /usr/local/bin/chromedriver
            /usr/local/bin/chromedriver --version
          elif [ -f "/usr/bin/chromedriver" ]; then
            echo "âœ… ä½¿ç”¨ç³»ç»ŸChromeDriver:"
            ls -la /usr/bin/chromedriver
            /usr/bin/chromedriver --version
          else
            echo "âš ï¸ ChromeDriverå®‰è£…å¯èƒ½æœ‰é—®é¢˜ï¼Œå°†ä¾èµ–webdriver-manager"
          fi

      - name: Setup Chrome for headless mode
        run: |
          # åˆ›å»ºscriptsç›®å½•
          mkdir -p scripts
          # åˆ›å»ºä¼˜åŒ–çš„é‡‡é›†å™¨è„šæœ¬
          cat > scripts/production-collector.py << 'EOF'
          #!/usr/bin/env python3
          """
          ç”Ÿäº§ç¯å¢ƒToolifyæ•°æ®é‡‡é›†å™¨
          """
          print("ğŸš€ Pythonè„šæœ¬å¼€å§‹æ‰§è¡Œ...")
          print("ğŸ“¦ å¼€å§‹å¯¼å…¥æ¨¡å—...")

          import os
          print("âœ… os æ¨¡å—å¯¼å…¥æˆåŠŸ")
          import time
          print("âœ… time æ¨¡å—å¯¼å…¥æˆåŠŸ")
          import json
          print("âœ… json æ¨¡å—å¯¼å…¥æˆåŠŸ")
          import requests
          print("âœ… requests æ¨¡å—å¯¼å…¥æˆåŠŸ")
          from datetime import datetime
          print("âœ… datetime æ¨¡å—å¯¼å…¥æˆåŠŸ")
          from selenium import webdriver
          print("âœ… selenium webdriver æ¨¡å—å¯¼å…¥æˆåŠŸ")
          from selenium.webdriver.common.by import By
          print("âœ… selenium By æ¨¡å—å¯¼å…¥æˆåŠŸ")
          from selenium.webdriver.support.ui import WebDriverWait
          print("âœ… selenium WebDriverWait æ¨¡å—å¯¼å…¥æˆåŠŸ")
          from selenium.webdriver.support import expected_conditions as EC
          print("âœ… selenium expected_conditions æ¨¡å—å¯¼å…¥æˆåŠŸ")
          from selenium.webdriver.chrome.service import Service
          print("âœ… selenium Service æ¨¡å—å¯¼å…¥æˆåŠŸ")
          from webdriver_manager.chrome import ChromeDriverManager
          print("âœ… webdriver_manager æ¨¡å—å¯¼å…¥æˆåŠŸ")

          print("ğŸ¯ æ‰€æœ‰æ¨¡å—å¯¼å…¥å®Œæˆï¼Œå¼€å§‹å®šä¹‰å‡½æ•°...")

          def setup_driver():
              """è®¾ç½®Chromeæµè§ˆå™¨ - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ç‰ˆæœ¬"""
              options = webdriver.ChromeOptions()

              # ç”Ÿäº§ç¯å¢ƒChromeè®¾ç½®
              options.add_argument("--headless")
              options.add_argument("--no-sandbox")
              options.add_argument("--disable-dev-shm-usage")
              options.add_argument("--disable-gpu")
              options.add_argument("--disable-web-security")
              options.add_argument("--disable-features=VizDisplayCompositor")
              options.add_argument("--window-size=1920,1080")
              options.add_argument("--lang=zh-CN")

              # åæ£€æµ‹è®¾ç½®
              options.add_argument("--disable-blink-features=AutomationControlled")
              options.add_argument("--disable-extensions")
              options.add_experimental_option("excludeSwitches", ["enable-automation"])
              options.add_experimental_option('useAutomationExtension', False)

              # æ›´çœŸå®çš„ç”¨æˆ·ä»£ç†
              user_agent = "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
              options.add_argument(f"--user-agent={user_agent}")

              try:
                  # å°è¯•å¤šç§ChromeDriverå®‰è£…æ–¹æ³•
                  driver_path = None

                  try:
                      # æ–¹æ³•1: ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„ChromeDriver
                      system_paths = ["/usr/local/bin/chromedriver", "/usr/bin/chromedriver"]
                      for path in system_paths:
                          if os.path.exists(path):
                              driver_path = path
                              print(f"ğŸ“¦ ä½¿ç”¨ç³»ç»ŸChromeDriver: {driver_path}")
                              break

                      if not driver_path:
                          # æ–¹æ³•2: ä½¿ç”¨webdriver-managerä½œä¸ºå¤‡é€‰
                          print("ğŸ”„ ä½¿ç”¨webdriver-managerä¸‹è½½ChromeDriver...")
                          driver_path = ChromeDriverManager().install()
                          print(f"ğŸ“¦ ChromeDriverè·¯å¾„: {driver_path}")

                          # ç¡®ä¿æœ‰æ‰§è¡Œæƒé™
                          import stat
                          current_permissions = os.stat(driver_path).st_mode
                          os.chmod(driver_path, current_permissions | stat.S_IEXEC)
                          print("âœ… ChromeDriveræƒé™å·²è®¾ç½®")

                  except Exception as e:
                      print(f"âš ï¸ ChromeDriverè®¾ç½®å¤±è´¥: {e}")
                      driver_path = "chromedriver"  # æœ€åå°è¯•PATHä¸­çš„chromedriver

                  service = Service(driver_path)
                  driver = webdriver.Chrome(service=service, options=options)
                  driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
                  print("âœ… Chromeæµè§ˆå™¨å¯åŠ¨æˆåŠŸ")
                  return driver

              except Exception as e:
                  print(f"âŒ Chromeå¯åŠ¨å¤±è´¥: {e}")
                  print(f"ğŸ” é”™è¯¯ç±»å‹: {type(e).__name__}")
                  import traceback
                  print(f"ğŸ“‹ è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")
                  return None

          def get_settings_from_db():
              """ä»æ•°æ®åº“è·å–é‡‡é›†è®¾ç½®"""
              print("ğŸ—ï¸ get_settings_from_db å‡½æ•°å¼€å§‹")
              try:
                  print("ğŸ“¦ å¯¼å…¥requestsæ¨¡å—...")
                  import requests

                  print("ğŸ” è·å–ç¯å¢ƒå˜é‡...")
                  url = os.getenv('SUPABASE_URL')
                  key = os.getenv('SUPABASE_ANON_KEY')
                  print(f"ğŸ“Š ç¯å¢ƒå˜é‡çŠ¶æ€: URL={bool(url)}, KEY={bool(key)}")

                  if not url or not key:
                      print("âš ï¸ æ•°æ®åº“é…ç½®ç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®")
                      return {
                          'target_count': 3000,
                          'enabled': True,
                          'max_scroll_attempts': 60,
                          'batch_size': 100,
                          'retry_attempts': 3
                      }

                  # æ¸…ç†ç¯å¢ƒå˜é‡ä¸­çš„æ— æ•ˆå­—ç¬¦å’ŒGitHubæ ‡è®°
                  url = url.strip()
                  key = key.strip()

                  # ç§»é™¤å¯èƒ½çš„GitHubæ ‡è®°
                  if '***' in key:
                      print("âš ï¸ æ£€æµ‹åˆ°GitHubæ ‡è®°ï¼Œå°è¯•æ¸…ç†...")
                      key = key.replace('***', '')

                  # ç§»é™¤å…¶ä»–å¯èƒ½çš„æ— æ•ˆå­—ç¬¦
                  import re
                  key = re.sub(r'[^\w\-\.]', '', key)  # åªä¿ç•™å­—æ¯æ•°å­—å’Œ.-_

                  print(f"ğŸ”— è¿æ¥æ•°æ®åº“: {url[:50]}...")
                  print(f"ğŸ”‘ å¯†é’¥é•¿åº¦: {len(key)} å­—ç¬¦")
                  print(f"ğŸ”‘ å¯†é’¥å¼€å¤´: {key[:10]}...")
                  print(f"ğŸ”‘ å¯†é’¥ç»“å°¾: ...{key[-10:]}")

                  headers = {
                      'apikey': key,
                      'Authorization': f'Bearer {key}',
                      'Content-Type': 'application/json'
                  }

                  response = requests.get(f'{url}/rest/v1/system_settings', headers=headers)

                  if response.status_code == 200:
                      settings_data = response.json()
                      settings = {}

                      for setting in settings_data:
                          key_name = setting['setting_key']
                          value = setting['setting_value']

                          # ç±»å‹è½¬æ¢
                          if setting['setting_type'] == 'number':
                              value = int(value)
                          elif setting['setting_type'] == 'boolean':
                              value = value.lower() == 'true'

                          settings[key_name] = value

                      return {
                          'target_count': settings.get('collection_target_count', 3000),
                          'enabled': settings.get('collection_enabled', True),
                          'max_scroll_attempts': settings.get('max_scroll_attempts', 60),
                          'batch_size': settings.get('batch_size', 100),
                          'retry_attempts': settings.get('retry_attempts', 3)
                      }
                  else:
                      print(f"âš ï¸ è·å–è®¾ç½®å¤±è´¥: {response.status_code}")
                      return {
                          'target_count': 3000,
                          'enabled': True,
                          'max_scroll_attempts': 60,
                          'batch_size': 100,
                          'retry_attempts': 3
                      }
              except Exception as e:
                  print(f"âš ï¸ è·å–è®¾ç½®å‡ºé”™: {e}")
                  return {
                      'target_count': 3000,
                      'enabled': True,
                      'max_scroll_attempts': 60,
                      'batch_size': 100,
                      'retry_attempts': 3
                  }

          def collect_toolify_data(target_count=3000, max_scroll_attempts=60):
              """é‡‡é›†Toolifyæ•°æ®"""
              print(f"ğŸš€ å¼€å§‹é‡‡é›†æœ€å¤š {target_count} æ¡å·¥å…·æ•°æ®...")

              driver = setup_driver()
              if not driver:
                  return []

              tools_data = []

              try:
                  url = "https://www.toolify.ai/zh/Best-trending-AI-Tools"
                  print(f"ğŸ“± æ­£åœ¨è®¿é—®: {url}")

                  driver.get(url)

                  print("â³ ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½...")
                  time.sleep(5)

                  # æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£ç¡®åŠ è½½
                  page_title = driver.title
                  print(f"ğŸ“„ é¡µé¢æ ‡é¢˜: {page_title}")

                  # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®è¡¨æ ¼
                  try:
                      initial_rows = driver.find_elements(By.CSS_SELECTOR, "tr.el-table__row")
                      print(f"ğŸ” åˆå§‹åŠ è½½å‘ç° {len(initial_rows)} è¡Œæ•°æ®")
                      if len(initial_rows) == 0:
                          print("âš ï¸ è­¦å‘Šï¼šæœªå‘ç°æ•°æ®è¡Œï¼Œé¡µé¢å¯èƒ½æœªæ­£ç¡®åŠ è½½")
                          # å°è¯•ç­‰å¾…æ›´é•¿æ—¶é—´
                          print("â³ å†ç­‰å¾…5ç§’...")
                          time.sleep(5)
                          initial_rows = driver.find_elements(By.CSS_SELECTOR, "tr.el-table__row")
                          print(f"ğŸ” é‡æ–°æ£€æŸ¥å‘ç° {len(initial_rows)} è¡Œæ•°æ®")
                  except Exception as e:
                      print(f"âŒ æ£€æŸ¥åˆå§‹æ•°æ®æ—¶å‡ºé”™: {e}")
                  time.sleep(10)  # å¢åŠ ç­‰å¾…æ—¶é—´

                  print("ğŸ” å¼€å§‹æ•°æ®é‡‡é›†...")

                  scroll_attempts = 0
                  max_scroll_attempts = 60  # æœ€å¤šæ»šåŠ¨60æ¬¡
                  no_new_data_count = 0

                  while len(tools_data) < target_count and scroll_attempts < max_scroll_attempts:
                      try:
                          print(f"ğŸ“Š ç¬¬{scroll_attempts + 1}æ¬¡æ»šåŠ¨ - å½“å‰å·²é‡‡é›†: {len(tools_data)}/{target_count} æ¡")

                          current_rows = driver.find_elements(By.CSS_SELECTOR, "tr.el-table__row")

                          if not current_rows:
                              print("âš ï¸ æœªæ‰¾åˆ°æ•°æ®è¡Œï¼Œç­‰å¾…é¡µé¢åŠ è½½...")
                              time.sleep(3)  # å‡å°‘ç­‰å¾…æ—¶é—´
                              scroll_attempts += 1
                              continue

                          print(f"ğŸ” é¡µé¢å½“å‰æ˜¾ç¤º {len(current_rows)} è¡Œæ•°æ®")

                          # æå–æ–°æ•°æ®
                          initial_count = len(tools_data)
                          for i in range(len(tools_data), min(len(current_rows), target_count)):
                              try:
                                  row = current_rows[i]

                                  # æå–å·¥å…·æ•°æ®
                                  tool_link = row.find_element(By.CSS_SELECTOR, ".go-tool")
                                  tool_name = tool_link.text.strip()
                                  tool_url = tool_link.get_attribute("href")

                                  cells = row.find_elements(By.TAG_NAME, "td")

                                  tool_data = {
                                      "ranking": i + 1,
                                      "tool_name": tool_name,
                                      "tool_url": f"https://www.toolify.ai{tool_url}" if tool_url.startswith("/") else tool_url,
                                      "monthly_visits": cells[2].find_element(By.TAG_NAME, "span").text.strip() if len(cells) > 2 else "",
                                      "growth": cells[3].find_element(By.TAG_NAME, "span").text.strip() if len(cells) > 3 else "",
                                      "growth_rate": cells[4].find_element(By.TAG_NAME, "span").text.strip() if len(cells) > 4 else "",
                                      "description": cells[5].find_element(By.TAG_NAME, "p").text.strip() if len(cells) > 5 else "",
                                      "tags": cells[6].find_element(By.TAG_NAME, "p").text.strip() if len(cells) > 6 else "",
                                      "collected_at": datetime.now().isoformat(),
                                      "collection_batch": f"github-actions-{datetime.now().strftime('%Y-%m-%d')}"
                                  }

                                  tools_data.append(tool_data)

                                  if len(tools_data) % 50 == 0:
                                      print(f"ğŸ“Š å·²é‡‡é›† {len(tools_data)} æ¡æ•°æ®...")

                              except Exception as e:
                                  print(f"âŒ æå–ç¬¬{i+1}è¡Œæ•°æ®å¤±è´¥: {e}")

                          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®
                          new_data_count = len(tools_data) - initial_count
                          if new_data_count > 0:
                              print(f"âœ… æœ¬æ¬¡æ»šåŠ¨æ–°å¢ {new_data_count} æ¡æ•°æ®")
                              no_new_data_count = 0
                          else:
                              no_new_data_count += 1
                              print(f"âš ï¸ æœ¬æ¬¡æ»šåŠ¨æ— æ–°æ•°æ® (è¿ç»­{no_new_data_count}æ¬¡)")
                              if no_new_data_count >= 3:
                                  print("ğŸ›‘ è¿ç»­å¤šæ¬¡æ— æ–°æ•°æ®ï¼Œåœæ­¢é‡‡é›†")
                                  break

                          # å¦‚æœè¾¾åˆ°ç›®æ ‡æ•°é‡ï¼Œé€€å‡º
                          if len(tools_data) >= target_count:
                              print(f"ğŸ‰ å·²è¾¾åˆ°ç›®æ ‡æ•°é‡ {target_count} æ¡ï¼")
                              break

                          # æ™ºèƒ½æ»šåŠ¨ç­–ç•¥
                          print(f"ğŸ”„ æ‰§è¡Œæ»šåŠ¨ç­–ç•¥...")

                          if scroll_attempts % 3 == 0:
                              print("ğŸ“œ æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨")
                              driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
                          elif scroll_attempts % 3 == 1:
                              print("ğŸ“œ å‘ä¸‹æ»šåŠ¨3000åƒç´ ")
                              driver.execute_script("window.scrollBy(0, 3000);")
                          else:
                              print("ğŸ“œ æ»šåŠ¨åˆ°åº•éƒ¨åå›æ»š200åƒç´ ")
                              driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
                              time.sleep(1)
                              driver.execute_script("window.scrollBy(0, -200);")

                          print("â³ ç­‰å¾…é¡µé¢åŠ è½½...")
                          time.sleep(4)  # å‡å°‘ç­‰å¾…æ—¶é—´ä»8ç§’åˆ°4ç§’
                          scroll_attempts += 1

                      except Exception as e:
                          print(f"âŒ æ»šåŠ¨é‡‡é›†å‡ºé”™: {e}")
                          scroll_attempts += 1
                          time.sleep(5)

                  print(f"âœ… é‡‡é›†å®Œæˆï¼å…±è·å– {len(tools_data)} æ¡æ•°æ®")

                  # è¾“å‡ºé‡‡é›†æ•°æ®æ ·æœ¬ç”¨äºè°ƒè¯•
                  if tools_data:
                      print("ğŸ“‹ é‡‡é›†æ•°æ®æ ·æœ¬ï¼ˆå‰3æ¡ï¼‰:")
                      for i, tool in enumerate(tools_data[:3]):
                          print(f"   {i+1}. {tool.get('tool_name', 'N/A')} - {tool.get('monthly_visits', 'N/A')}")

                  return tools_data[:target_count]

              except Exception as e:
                  print(f"âŒ é‡‡é›†è¿‡ç¨‹å‡ºé”™: {e}")
                  return tools_data

              finally:
                  print("ğŸ”š å…³é—­æµè§ˆå™¨...")
                  driver.quit()

          def upload_to_supabase(tools_data):
              """ä¸Šä¼ æ•°æ®åˆ°Supabase - æ”¹è¿›ç‰ˆUPSERTé€»è¾‘"""
              if not tools_data:
                  print("âŒ æ²¡æœ‰æ•°æ®éœ€è¦ä¸Šä¼ ")
                  return False

              url = os.getenv('SUPABASE_URL')
              key = os.getenv('SUPABASE_ANON_KEY')

              if not url or not key:
                  print("âŒ Supabaseé…ç½®ç¼ºå¤±")
                  print(f"   SUPABASE_URL: {'âœ… å·²è®¾ç½®' if url else 'âŒ æœªè®¾ç½®'}")
                  print(f"   SUPABASE_ANON_KEY: {'âœ… å·²è®¾ç½®' if key else 'âŒ æœªè®¾ç½®'}")
                  return False

              # æ¸…ç†ç¯å¢ƒå˜é‡
              url = url.strip()
              key = key.strip()

              print(f"ğŸ“¤ å‡†å¤‡ä¸Šä¼  {len(tools_data)} æ¡æ•°æ®åˆ°: {url[:50]}...")
              print(f"ğŸ”‘ APIå¯†é’¥é•¿åº¦: {len(key)} å­—ç¬¦")

              # å…ˆæµ‹è¯•è¿æ¥
              test_headers = {
                  'apikey': key,
                  'Authorization': f'Bearer {key}',
                  'Content-Type': 'application/json'
              }

              try:
                  print("ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥...")
                  test_response = requests.get(f'{url}/rest/v1/toolify_tools?limit=1', headers=test_headers, timeout=10)
                  print(f"ğŸ“Š è¿æ¥æµ‹è¯•å“åº”: {test_response.status_code}")

                  if test_response.status_code != 200:
                      print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {test_response.text}")
                      return False
                  else:
                      print("âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸")
              except Exception as e:
                  print(f"âŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸: {e}")
                  return False

              # ä½¿ç”¨å•æ¡UPSERTç¡®ä¿æ•°æ®æ­£ç¡®æ’å…¥
              success_count = 0
              error_count = 0

              for i, tool in enumerate(tools_data):
                  try:
                      # ä¸ºæ¯ä¸ªå·¥å…·æ‰§è¡Œå•ç‹¬çš„UPSERTæ“ä½œ
                      upsert_headers = {
                          'apikey': key,
                          'Authorization': f'Bearer {key}',
                          'Content-Type': 'application/json',
                          'Prefer': 'resolution=merge-duplicates'
                      }

                      response = requests.post(
                          f'{url}/rest/v1/toolify_tools',
                          headers=upsert_headers,
                          json=tool,
                          timeout=30
                      )

                      if response.status_code in [200, 201]:
                          success_count += 1
                          if (i + 1) % 50 == 0:
                              print(f"ğŸ“Š å·²å¤„ç† {i + 1}/{len(tools_data)} æ¡æ•°æ®...")
                      elif response.status_code == 409:
                          # å¦‚æœé‡åˆ°å†²çªï¼Œå°è¯•æ›´æ–°ç°æœ‰è®°å½•
                          try:
                              update_headers = {
                                  'apikey': key,
                                  'Authorization': f'Bearer {key}',
                                  'Content-Type': 'application/json'
                              }

                              update_response = requests.patch(
                                  f'{url}/rest/v1/toolify_tools?tool_name=eq.{tool["tool_name"]}',
                                  headers=update_headers,
                                  json=tool,
                                  timeout=30
                              )

                              if update_response.status_code in [200, 204]:
                                  success_count += 1
                                  if (i + 1) % 50 == 0:
                                      print(f"ğŸ“Š å·²æ›´æ–° {i + 1}/{len(tools_data)} æ¡æ•°æ®...")
                              else:
                                  error_count += 1
                                  print(f"âŒ æ›´æ–°å¤±è´¥ {tool['tool_name']}: {update_response.status_code} {update_response.text}")
                          except Exception as update_e:
                              error_count += 1
                              print(f"âŒ æ›´æ–°å¼‚å¸¸ {tool['tool_name']}: {update_e}")
                      else:
                          error_count += 1
                          print(f"âŒ ä¸Šä¼ å¤±è´¥ {tool['tool_name']}: {response.status_code} {response.text}")

                  except Exception as e:
                      error_count += 1
                      print(f"âŒ å¤„ç†å¼‚å¸¸ {tool.get('tool_name', 'Unknown')}: {e}")

              print(f"ğŸ“Š ä¸Šä¼ å®Œæˆç»Ÿè®¡:")
              print(f"   âœ… æˆåŠŸ: {success_count} æ¡")
              print(f"   âŒ å¤±è´¥: {error_count} æ¡")
              print(f"   ğŸ“ˆ æˆåŠŸç‡: {success_count/(success_count+error_count)*100:.1f}%")

              # åªè¦æœ‰éƒ¨åˆ†æˆåŠŸå°±è®¤ä¸ºä»»åŠ¡æˆåŠŸ
              return success_count > 0

          def main():
              print("ğŸ”¥ mainå‡½æ•°å¼€å§‹æ‰§è¡Œ")
              print("=" * 50)
              print("ğŸ¯ Toolifyç”Ÿäº§ç¯å¢ƒæ•°æ®é‡‡é›†")
              print("=" * 50)

              print("ğŸ”— å‡†å¤‡ä»æ•°æ®åº“è·å–è®¾ç½®...")
              # ä»æ•°æ®åº“è·å–è®¾ç½®
              settings = get_settings_from_db()
              print("âœ… æ•°æ®åº“è®¾ç½®è·å–å®Œæˆ")
              print(f"ğŸ“‹ é‡‡é›†è®¾ç½®: {settings}")

              # æ£€æŸ¥æ˜¯å¦æ˜¯æ‰‹åŠ¨è§¦å‘
              manual_target = os.getenv('INPUT_TARGET_COUNT')
              if manual_target:
                  print(f"ğŸ¯ æ‰‹åŠ¨è§¦å‘ï¼Œç›®æ ‡æ•°é‡: {manual_target}")
                  target_count = int(manual_target)
                  max_scroll_attempts = settings['max_scroll_attempts']
              else:
                  # è‡ªåŠ¨æ‰§è¡Œï¼Œæ£€æŸ¥æ˜¯å¦å¯ç”¨
                  if not settings['enabled']:
                      print("â¸ï¸ å®šæ—¶é‡‡é›†å·²ç¦ç”¨ï¼Œè·³è¿‡æ‰§è¡Œ")
                      return

                  target_count = settings['target_count']
                  max_scroll_attempts = settings['max_scroll_attempts']

              print(f"ğŸ¯ æœ€ç»ˆé‡‡é›†ç›®æ ‡: {target_count} æ¡")

              # é‡‡é›†æ•°æ®
              tools_data = collect_toolify_data(
                  target_count=target_count,
                  max_scroll_attempts=max_scroll_attempts
              )

              if not tools_data:
                  print("ğŸ’¥ é‡‡é›†å¤±è´¥ï¼Œæ²¡æœ‰è·å–åˆ°æ•°æ®")
                  exit(1)

              # ä¿å­˜æœ¬åœ°å¤‡ä»½
              backup_file = f"./toolify-backup-{datetime.now().strftime('%Y-%m-%d')}.json"
              with open(backup_file, 'w', encoding='utf-8') as f:
                  json.dump(tools_data, f, ensure_ascii=False, indent=2)
              print(f"ğŸ’¾ æœ¬åœ°å¤‡ä»½å·²ä¿å­˜: {backup_file}")

              # ä¸Šä¼ åˆ°Supabase
              upload_success = upload_to_supabase(tools_data)

              if upload_success:
                  print("ğŸ‰ æ•°æ®é‡‡é›†å’Œä¸Šä¼ ä»»åŠ¡å®Œæˆï¼")
              else:
                  print("ğŸ’¥ æ•°æ®ä¸Šä¼ å¤±è´¥")
                  exit(1)

          if __name__ == "__main__":
              print("ğŸ¬ è¿›å…¥mainå‡½æ•°...")
              main()
              print("ğŸ mainå‡½æ•°æ‰§è¡Œå®Œæˆ")
          EOF

      - name: Run data collection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          INPUT_TARGET_COUNT: ${{ github.event.inputs.target_count }}
        run: |
          echo "ğŸ”§ ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          echo "   TARGET_COUNTè¾“å…¥: ${{ github.event.inputs.target_count }}"
          echo "   INPUT_TARGET_COUNT: $INPUT_TARGET_COUNT"
          echo "   QUICK_TESTæ¨¡å¼: ${{ github.event.inputs.quick_test }}"

          if [ "${{ github.event.inputs.quick_test }}" = "true" ]; then
            echo "ğŸ§ª è¿è¡Œå¿«é€Ÿæµ‹è¯•æ¨¡å¼..."
            python scripts/quick-test-collector.py
          else
            echo "ğŸ”„ è¿è¡Œå®Œæ•´æ•°æ®é‡‡é›†..."
            python scripts/production-collector.py
          fi

      - name: Upload backup on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: collection-backup-${{ github.run_number }}
          path: ./toolify-backup-*.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… æ•°æ®é‡‡é›†æˆåŠŸå®Œæˆäº $(date)"
          echo "ğŸ“Š æŸ¥çœ‹æœ€æ–°æ•°æ®: https://your-toolify-app.vercel.app"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ æ•°æ®é‡‡é›†å¤±è´¥äº $(date)"
          echo "ğŸ“‹ è¯·æ£€æŸ¥æ—¥å¿—å’Œå¤‡ä»½æ–‡ä»¶"